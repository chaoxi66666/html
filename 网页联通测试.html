<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网页检测工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { margin-bottom: 20px; color: #333; }
        .input-area { margin-bottom: 20px; }
        .url-input { 
            width: 300px; 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 14px; 
        }
        .test-btn { 
            padding: 9px 15px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
            margin-left: 10px;
        }
        .test-btn:hover { background: #0056b3; }
        .loading { 
            display: none; 
            color: #666; 
            margin-top: 10px; 
        }
        .error { 
            display: none; 
            color: #d32f2f; 
            margin-top: 10px; 
        }
        .results { 
            display: none; 
            margin-top: 20px; 
            border-top: 1px solid #ddd; 
            padding-top: 20px; 
        }
        .result-item { 
            margin-bottom: 15px; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            background: #f9f9f9; 
        }
        .result-title { 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #333; 
        }
        .result-content { 
            font-size: 14px; 
            color: #555; 
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-bad { color: #dc3545; }
    </style>
</head>
<body>
    <h1>网页检测工具</h1>
    <h2>开发者：River</h2>
    
    <div class="input-area">
        <input type="url" class="url-input" id="urlInput" placeholder="https://example.com">
        <button class="test-btn" id="testBtn">开始检测</button>
        <div class="loading" id="loadingIndicator">正在检测中...</div>
        <div class="error" id="errorMessage"></div>
    </div>
    
    <div class="results" id="results">
        <div class="result-item">
            <div class="result-title">连接测试</div>
            <div class="result-content" id="connectivityResult"></div>
        </div>
        
        <div class="result-item">
            <div class="result-title">网速测试</div>
            <div class="result-content" id="speedResult"></div>
        </div>
        
        <div class="result-item">
            <div class="result-title">安全性检测</div>
            <div class="result-content" id="securityResult"></div>
        </div>
        
        <div class="result-item">
            <div class="result-title">协议信息</div>
            <div class="result-content" id="protocolResult"></div>
        </div>
        
        <div class="result-item">
            <div class="result-title">服务器信息</div>
            <div class="result-content" id="serverResult"></div>
        </div>
    </div>

    <script>
        document.getElementById('testBtn').addEventListener('click', runTests);
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') runTests();
        });

        async function runTests() {
            const url = document.getElementById('urlInput').value.trim();
            const errorEl = document.getElementById('errorMessage');
            const loadingEl = document.getElementById('loadingIndicator');
            const resultsEl = document.getElementById('results');
            
            // 验证URL
            if (!url) {
                showError('请输入URL');
                return;
            }
            
            // 确保URL有协议前缀
            let testUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                testUrl = 'https://' + url;
            }
            
            // 显示加载状态
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsEl.style.display = 'none';
            
            try {
                // 清理显示区域
                clearResults();
                
                // 执行各项测试
                await testConnectivity(testUrl);
                await testSpeed(testUrl);
                await testSecurity(testUrl);
                await testProtocol(testUrl);
                await testServerInfo(testUrl);
                
                // 显示结果
                resultsEl.style.display = 'block';
                
            } catch (error) {
                showError('检测失败: ' + error.message);
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        async function testConnectivity(url) {
            const resultEl = document.getElementById('connectivityResult');
            resultEl.innerHTML = '正在测试连接...';
            
            try {
                const startTime = Date.now();
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(url, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                resultEl.innerHTML = `连接成功！响应时间: ${responseTime}ms`;
                resultEl.className = 'result-content status-good';
                
            } catch (error) {
                // 尝试使用代理测试连接
                try {
                    const proxyResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                    if (proxyResponse.ok) {
                        resultEl.innerHTML = '通过代理连接成功（直接连接失败）';
                        resultEl.className = 'result-content status-warning';
                    } else {
                        throw new Error('代理连接也失败');
                    }
                } catch (proxyError) {
                    resultEl.innerHTML = '连接失败: ' + error.message;
                    resultEl.className = 'result-content status-bad';
                }
            }
        }

        async function testSpeed(url) {
            const resultEl = document.getElementById('speedResult');
            resultEl.innerHTML = '正在测试网速...';
            
            try {
                const sizes = [10, 50, 100]; // KB
                let totalSize = 0;
                let totalTime = 0;
                
                for (const size of sizes) {
                    const testUrl = `${url}?size=${size}&t=${Date.now()}`;
                    const startTime = Date.now();
                    
                    // 创建一个指定大小的测试请求
                    await fetch(testUrl, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    if (duration > 0) {
                        totalSize += size;
                        totalTime += duration;
                    }
                }
                
                if (totalTime > 0) {
                    // 计算平均速度 (KB/s)
                    const speedKBps = Math.round((totalSize / totalTime) * 1000);
                    let speedText;
                    
                    if (speedKBps > 1000) {
                        speedText = `${(speedKBps / 1000).toFixed(1)} MB/s`;
                    } else {
                        speedText = `${speedKBps} KB/s`;
                    }
                    
                    resultEl.innerHTML = `预估网速: ${speedText}`;
                    if (speedKBps > 500) {
                        resultEl.className = 'result-content status-good';
                    } else if (speedKBps > 100) {
                        resultEl.className = 'result-content status-warning';
                    } else {
                        resultEl.className = 'result-content status-bad';
                    }
                } else {
                    resultEl.innerHTML = '无法准确测试网速';
                    resultEl.className = 'result-content status-warning';
                }
                
            } catch (error) {
                resultEl.innerHTML = '网速测试失败';
                resultEl.className = 'result-content status-warning';
            }
        }

        async function testSecurity(url) {
            const resultEl = document.getElementById('securityResult');
            resultEl.innerHTML = '正在检测安全性...';
            
            try {
                const urlObj = new URL(url);
                const isHttps = urlObj.protocol === 'https:';
                
                let securityIssues = [];
                
                if (!isHttps) {
                    securityIssues.push('使用HTTP协议（不安全）');
                }
                
                // 检查是否混合内容（需要在真实页面中检查）
                if (isHttps) {
                    // 尝试检查证书
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            securityIssues.push('HTTPS证书可能存在问题');
                        } else {
                            resultEl.innerHTML = '使用HTTPS协议（安全）';
                            resultEl.className = 'result-content status-good';
                            return;
                        }
                    } catch (certError) {
                        securityIssues.push('HTTPS证书验证失败');
                    }
                }
                
                if (securityIssues.length > 0) {
                    resultEl.innerHTML = `安全问题: ${securityIssues.join('; ')}`;
                    resultEl.className = 'result-content status-bad';
                } else {
                    resultEl.innerHTML = '安全性良好';
                    resultEl.className = 'result-content status-good';
                }
                
            } catch (error) {
                resultEl.innerHTML = '安全性检测失败: ' + error.message;
                resultEl.className = 'result-content status-warning';
            }
        }

        async function testProtocol(url) {
            const resultEl = document.getElementById('protocolResult');
            
            try {
                const urlObj = new URL(url);
                const protocol = urlObj.protocol;
                
                // 检查HTTP/2支持
                let http2Support = '未知';
                try {
                    const response = await fetch(url);
                    const headers = response.headers;
                    
                    // 检查是否使用HTTP/2
                    if (response.ok) {
                        http2Support = '可能支持HTTP/2';
                    }
                } catch (e) {
                    http2Support = '无法检测';
                }
                
                resultEl.innerHTML = `
                    协议: ${protocol}<br>
                    HTTP版本: ${http2Support}<br>
                    主机: ${urlObj.host}<br>
                    路径: ${urlObj.pathname}
                `;
                resultEl.className = 'result-content';
                
            } catch (error) {
                resultEl.innerHTML = '协议检测失败: ' + error.message;
                resultEl.className = 'result-content status-warning';
            }
        }

        async function testServerInfo(url) {
            const resultEl = document.getElementById('serverResult');
            resultEl.innerHTML = '正在获取服务器信息...';
            
            try {
                const startTime = Date.now();
                const response = await fetch(url, {
                    method: 'HEAD',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                const endTime = Date.now();
                
                let serverInfo = [];
                
                // 获取服务器头信息
                const serverHeader = response.headers.get('server');
                if (serverHeader) {
                    serverInfo.push(`服务器: ${serverHeader}`);
                }
                
                // 获取其他相关头信息
                const contentType = response.headers.get('content-type');
                if (contentType) {
                    serverInfo.push(`内容类型: ${contentType}`);
                }
                
                const contentLength = response.headers.get('content-length');
                if (contentLength) {
                    serverInfo.push(`内容大小: ${Math.round(contentLength / 1024)} KB`);
                }
                
                const responseTime = endTime - startTime;
                serverInfo.push(`响应时间: ${responseTime}ms`);
                
                if (serverInfo.length > 0) {
                    resultEl.innerHTML = serverInfo.join('<br>');
                } else {
                    resultEl.innerHTML = '无法获取服务器信息';
                }
                
                resultEl.className = 'result-content';
                
            } catch (error) {
                // 尝试使用代理获取信息
                try {
                    const proxyResponse = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
                    if (proxyResponse.ok) {
                        resultEl.innerHTML = '通过代理获取信息成功（直接获取失败）';
                    } else {
                        resultEl.innerHTML = '服务器信息获取失败';
                    }
                } catch (proxyError) {
                    resultEl.innerHTML = '服务器信息获取失败: ' + error.message;
                }
                resultEl.className = 'result-content status-warning';
            }
        }

        function clearResults() {
            const resultElements = document.querySelectorAll('.result-content');
            resultElements.forEach(el => {
                el.innerHTML = '';
                el.className = 'result-content';
            });
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('loadingIndicator').style.display = 'none';
        }
    </script>
</body>
</html>